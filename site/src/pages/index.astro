---
import { getCollection } from 'astro:content';
import Base from '../layouts/Base.astro';
import sections from '../../../dashboard_sections.json';

const base = import.meta.env.BASE_URL.replace(/\/$/, '');
const allNotes = await getCollection('vault');

const dashboardSections = sections.map(s => ({
  label: s.label,
  notes: allNotes
    .filter(n => n.data.tags.includes(s.tag) && n.data.status !== 'archived')
    .sort((a, b) => b.data.revised.getTime() - a.data.revised.getTime()),
}));

function formatDate(d: Date): string {
  return d.toISOString().slice(0, 10);
}

function noteTitle(id: string): string {
  const basename = id.split('/').pop()!;
  return basename.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
}
---
<Base title="Dashboard">
  <h1 class="mb-4 text-2xl font-bold">Galaxy Brain</h1>

  {dashboardSections.map(section => (
    <Fragment>
      <h2 class="mt-6 mb-2 text-xl font-semibold">{section.label}</h2>
      <table class="data-table">
        <thead><tr><th>Name</th><th>Status</th><th>Revised</th><th>Rev</th></tr></thead>
        <tbody>
          {section.notes.map(n => (
            <tr>
              <td><a href={`${base}/${n.id}/`}>{n.data.title || noteTitle(n.id)}</a></td>
              <td><span class={`badge badge-${n.data.status}`}>{n.data.status}</span></td>
              <td>{formatDate(n.data.revised)}</td>
              <td>{n.data.revision}</td>
            </tr>
          ))}
        </tbody>
      </table>
    </Fragment>
  ))}
</Base>
