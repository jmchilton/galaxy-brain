---
import { getCollection, render } from 'astro:content';
import Base from '../../../layouts/Base.astro';

export async function getStaticPaths() {
  const entries = await getCollection('projectFiles');
  return entries.map(entry => {
    // entry.id is like "projects/sample-project/overview"
    const parts = entry.id.split('/');
    const project = parts[1];
    const file = parts.slice(2).join('/');
    return {
      params: { project, file },
      props: { entry },
    };
  });
}

const { entry } = Astro.props;
const { Content } = await render(entry);

const base = import.meta.env.BASE_URL.replace(/\/$/, '');

// Derive page title from filename
const filename = entry.id.split('/').pop()!;
const pageTitle = filename.replace(/-/g, ' ').replace(/\b\w/g, (c: string) => c.toUpperCase());

// Look up parent project
const allNotes = await getCollection('vault');
const projectSlug = entry.id.split('/').slice(0, 2).join('/');
const parentProject = allNotes.find(n => n.id === projectSlug);
const projectTitle = parentProject?.data.title
  || projectSlug.split('/').pop()!.replace(/-/g, ' ').replace(/\b\w/g, (c: string) => c.toUpperCase());
---
<Base title={pageTitle} pageTitle={pageTitle}>
  <nav class="mb-4 text-sm text-(--color-text-secondary)">
    <a href={`${base}/`} class="text-(--color-link) hover:underline">Home</a>
    <span class="mx-1">&rsaquo;</span>
    <a href={`${base}/${projectSlug}/`} class="text-(--color-link) hover:underline">{projectTitle}</a>
    <span class="mx-1">&rsaquo;</span>
    <span>{pageTitle}</span>
  </nav>

  <h1 class="mb-4 text-2xl font-bold">{pageTitle}</h1>

  <article class="prose prose-slate max-w-none dark:prose-invert">
    <Content />
  </article>
</Base>
