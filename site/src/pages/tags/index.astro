---
import { getCollection } from 'astro:content';
import Base from '../../layouts/Base.astro';

const base = import.meta.env.BASE_URL.replace(/\/$/, '');
const allNotes = await getCollection('vault');

// Count tags across non-archived notes
const tagCounts = new Map<string, number>();
for (const note of allNotes) {
  if (note.data.status === 'archived') continue;
  for (const tag of note.data.tags) {
    tagCounts.set(tag, (tagCounts.get(tag) || 0) + 1);
  }
}

const sorted = [...tagCounts.entries()].sort((a, b) => a[0].localeCompare(b[0]));

const noteTypeTags = sorted.filter(([t]) =>
  t.startsWith('research/') || t.startsWith('plan') || t === 'concept' || t === 'moc' || t === 'project'
);
const galaxyAreaTags = sorted.filter(([t]) => t.startsWith('galaxy/'));
const otherTags = sorted.filter(([t]) =>
  !t.startsWith('research/') && !t.startsWith('plan') && t !== 'concept' && t !== 'moc' && !t.startsWith('galaxy/')
);
---
<Base title="Tags" pageTitle="Tags">
  <h1 class="mb-4 text-2xl font-bold">Tags</h1>

  <h2 class="mt-6 mb-2 text-xl font-semibold">Note Type Tags</h2>
  <ul class="list-none my-2 mb-6 p-0 flex flex-wrap gap-2">
    {noteTypeTags.map(([tag, count]) => (
      <li class="flex items-center gap-1">
        <a href={`${base}/tags/${tag}/`} class="no-underline"><span class="tag">{tag}</span></a>
        <span class="text-xs text-(--color-text-secondary)">({count})</span>
      </li>
    ))}
  </ul>

  {galaxyAreaTags.length > 0 && (
    <>
      <h2 class="mt-6 mb-2 text-xl font-semibold">Galaxy Area Tags</h2>
      <ul class="list-none my-2 mb-6 p-0 flex flex-wrap gap-2">
        {galaxyAreaTags.map(([tag, count]) => (
          <li class="flex items-center gap-1">
            <a href={`${base}/tags/${tag}/`} class="no-underline"><span class="tag">{tag}</span></a>
            <span class="text-xs text-(--color-text-secondary)">({count})</span>
          </li>
        ))}
      </ul>
    </>
  )}

  {otherTags.length > 0 && (
    <>
      <h2 class="mt-6 mb-2 text-xl font-semibold">Other Tags</h2>
      <ul class="list-none my-2 mb-6 p-0 flex flex-wrap gap-2">
        {otherTags.map(([tag, count]) => (
          <li class="flex items-center gap-1">
            <a href={`${base}/tags/${tag}/`} class="no-underline"><span class="tag">{tag}</span></a>
            <span class="text-xs text-(--color-text-secondary)">({count})</span>
          </li>
        ))}
      </ul>
    </>
  )}
</Base>
